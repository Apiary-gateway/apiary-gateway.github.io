---
const { children, headings } = Astro.props;
---

<div class="layout">
  <aside class="sidebar">
    <nav>
      <ul class="toc-list">
        {headings.map((item) => (
          <li>
            <a href={`#${item.id}`} class="toc-link" id={`link-${item.id}`}>
              {item.title}
            </a>
            {item.children && (
              <ul class="toc-sublist">
                {item.children.map((child) => (
                  <li>
                    <a href={`#${child.id}`} class="toc-link" id={`link-${child.id}`}>
                      {child.title}
                    </a>
                  </li>
                ))}
              </ul>
            )}
          </li>
        ))}
      </ul>
    </nav>
  </aside>

  <main class="content">
    <div class="content-wrapper">
      <slot />
    </div>
  </main>
</div>

<style>
  /* Ensure smooth scroll respects padding (e.g. if fixed headers exist) */
  html {
    scroll-padding-top: 6rem;
  }

  .layout {
    display: flex;
    background-color: var(--color-background);
    color: var(--color-text);
    min-height: 100vh;
    padding-top: 1rem;
  }

  .sidebar {
    min-width: 250px;
    width: 20%;
    height: calc(100vh - 1rem);
    flex-basis: 250px;
    position: fixed;
    top: 3rem;
    left: 0;
    padding: 2rem 0;
    overflow-y: auto;
    border-right: 1px solid var(--color-border);
    background-color: var(--color-background);
    z-index: 1;
  }

  .sidebar nav {
    background-color: inherit;
    padding: 0 1.5rem 0 1rem;
    height: 100%;
  }

  .content {
    flex: 1;
    padding: 2rem;
    margin-top: -2rem;
    margin-left: 20%;
    scroll-behavior: smooth;
    max-width: 100%;
    overflow-x: hidden;
    background-color: var(--color-background);
    color: var(--color-text);
  }

  .toc-list,
  .toc-sublist {
    list-style: none;
    padding-left: 0;
    margin-top: 0.25rem;
  }

  .toc-sublist {
    margin-left: 1rem;
    padding-left: 1rem;
  }

  .toc-link {
    display: block;
    padding: 0.3rem 0.5rem;
    color: var(--color-text);
    font-size: 1rem;
    text-decoration: none;
    transition: color 0.2s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .toc-link:hover {
    color: var(--color-primary);
  }

  .toc-link.active {
    color: var(--color-primary);
    font-weight: 500;
  }

  /* Content Styling */
  :global(.content-wrapper) {
    max-width: 800px;
    margin: 0 auto;
    width: 100%;
  }

  :global(.content-wrapper h2) {
    margin-top: 1rem;
    margin-bottom: 1rem;
    color: var(--color-text);
    font-size: 2rem;
    font-weight: 600;
    line-height: 1.3;
    scroll-margin-top: 6rem;
  }

  :global(.content-wrapper h3) {
    margin-top: 1rem;
    margin-bottom: 1rem;
    color: var(--color-text);
    font-size: 1.5rem;
    font-weight: 500;
    line-height: 1.4;
    scroll-margin-top: 6rem;
  }

  :global(.content-wrapper p) {
    margin-bottom: 1rem;
    line-height: 1.8;
    color: var(--color-text);
    text-align: left;
  }

  :global(.content-wrapper p:last-child) {
    margin-bottom: 0;
  }

  :global(.content-wrapper img) {
    max-width: 80%;
    height: auto;
    margin: 2rem auto;
    display: block;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  /* Section spacing */
  :global(.content-wrapper section) {
    padding-top: 0.5rem;
    margin-top: 0rem;
    margin-bottom: 0rem;
    padding-bottom: 0.5rem;
  }

  @media (max-width: 768px) {
    .sidebar {
      display: none;
    }

    .content {
      padding: 1.5rem;
      width: 100%;
      margin-left: 0;
    }

    :global(.content-wrapper) {
      max-width: 100%;
    }

    :global(.content-wrapper h2) {
      font-size: 1.75rem;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }

    :global(.content-wrapper h3) {
      font-size: 1.25rem;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }

    :global(.content-wrapper p) {
      line-height: 1.7;
      margin-bottom: 1.25rem;
    }

    :global(.content-wrapper img) {
      max-width: 100%;
    }
  }
</style>

<script>
  // Handle active state for TOC links and smooth scrolling
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        const id = entry.target.getAttribute('id');
        const link = document.querySelector(`a[href="#${id}"]`);
        if (entry.isIntersecting) {
          document.querySelectorAll('.toc-link').forEach((el) => {
            el.classList.remove('active');
          });
          link?.classList.add('active');
        }
      });
    },
    { rootMargin: '-50% 0px -50% 0px' }
  );

  document.querySelectorAll('h2, h3').forEach((heading) => {
    observer.observe(heading);
  });

  // Handle smooth scrolling with offset
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const targetId = this.getAttribute('href');
      const targetElement = document.querySelector(targetId);
      if (targetElement) {
        const headerOffset = 120; // Increased offset to ensure visibility
        const elementPosition = targetElement.getBoundingClientRect().top;
        const offsetPosition = elementPosition + window.pageYOffset - headerOffset;

        // Ensure we don't scroll past the top of the document
        const finalPosition = Math.max(0, offsetPosition);

        window.scrollTo({
          top: finalPosition,
          behavior: 'smooth'
        });
      }
    });
  });
</script>
